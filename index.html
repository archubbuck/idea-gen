<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App Imagineer</title>
  <!-- 1. Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 2. Font (Inter) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Simple fade-in for toast */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(10px); }
    }
    .toast-visible {
      animation: fadeIn 0.3s ease-out forwards;
    }
    .toast-hidden {
      animation: fadeOut 0.3s ease-in forwards;
    }
  </style>
  <!-- 3. React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- 4. Libraries -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://unpkg.com/zustand@4.5.2/esm/index.mjs" type="module"></script>
  <script src="https://unpkg.com/lucide-react@0.395.0/dist/umd/lucide-react.js"></script>
  <script src="https://unpkg.com/zustand/vanilla.js"></script>
  <script>
    // Make Zustand available globally
    window.zustand = window.zustandVanilla;
    window.zustand.create = window.zustand.createStore;
  </script>

</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <!-- 5. Your Application Code -->
  <script type="text/babel">
    // --- (A) Destructure Globals ---
    const { useState, useEffect, useCallback, useMemo, useRef, createContext, useContext } = React;
    const { 
      Home, Lightbulb, Users, LayoutDashboard, Settings, ArrowRight, Plus, Send, 
      Sparkles, Lock, Unlock, Image: ImageIcon, Check, X, MessageSquare, Heart, 
      Bookmark, Bell, LogIn, LogOut, Loader2, AlertTriangle, ChevronDown, 
      ChevronRight, Trash2, User: UserIcon, MoreVertical
    } = lucideReact;
    const { create } = window.zustand;

    // Firebase
    const { initializeApp } = firebase.app;
    const { 
      getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
      signInWithPopup, GoogleAuthProvider, signOut: firebaseSignOut
    } = firebase.auth;
    const { 
      getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
      collection, query, where, addDoc, getDocs, serverTimestamp, writeBatch,
      setLogLevel
    } = firebase.firestore;
    
    // --- (0) CONSTANTS & CONFIG ---

    const APP_NAME = "App Imagineer";

    // Firebase config (will be provided by the environment)
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      // Fallback config for local testing if needed, though environment is preferred
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Initialize Firebase
    let app, auth, db;
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      // Set Firestore log level
      setLogLevel('debug');
    } catch (e) {
      console.error("Error initializing Firebase:", e);
      document.getElementById('root').innerHTML = '<div style="padding: 2rem; text-align: center; font-family: sans-serif; color: red;"><h2>Firebase Initialization Error</h2><p>Please ensure your Firebase configuration is correct and environment variables (__firebase_config, __app_id) are properly injected.</p><p>Error: ' + e.message + '</p></div>';
    }


    // AI Models
    const CHAT_MODEL = "gemini-2.5-flash-preview-09-2025";
    const IMAGE_MODEL = "imagen-3.0-generate-002";

    // Firestore Paths
    const paths = {
      users: () => `artifacts/${appId}/public/data/users`,
      user: (uid) => `artifacts/${appId}/public/data/users/${uid}`,
      ideas: () => `artifacts/${appId}/public/data/ideas`,
      idea: (id) => `artifacts/${appId}/public/data/ideas/${id}`,
      comments: (ideaId) => `artifacts/${appId}/public/data/ideas/${ideaId}/comments`,
      subscriptions: (ideaId) => `artifacts/${appId}/public/data/ideas/${ideaId}/subscriptions`,
      betaSignups: (ideaId) => `artifacts/${appId}/public/data/ideas/${ideaId}/betaSignups`,
    };

    // Default empty idea structure, as per spec
    const EMPTY_IDEA_FIELDS = {
      title: "",
      oneLiner: "",
      audience: "",
      problem: "",
      features: [],
      monetization: "",
      techStack: "",
      differentiators: "",
      risks: "",
      tags: [],
      betaAvailable: false,
      betaLink: "",
      cover_image_url: "",
    };

    const REQUIRED_FIELDS = ['title', 'oneLiner', 'audience', 'problem', 'features', 'monetization', 'techStack', 'tags'];

    // --- (1) GLOBAL STATE (ZUSTAND) ---

    // As specified in section 16)
    const useGlobalStore = create((set, get) => ({
      // --- App State ---
      page: 'home', // 'home', 'community', 'brainstorm', 'ideaDetail', 'dashboard'
      authModalOpen: false,
      isAuthReady: false,
      toast: { id: 0, show: false, message: '', type: 'success' },

      // --- User State ---
      user: null, // Firebase auth user object
      userInfo: null, // Our user profile from Firestore

      // --- Data State ---
      ideas: [], // All published ideas
      activeIdeaId: null, // For 'ideaDetail' page
      activeIdeaData: null,
      activeIdeaComments: [],
      activeIdeaSubscriptions: [],
      activeIdeaBetaSignups: [],
      
      // --- Brainstorming State (as per spec) ---
      draft: {
        id: null,
        fields: { ...EMPTY_IDEA_FIELDS },
        locks: {}, // Record<keyof Fields, boolean>
        previews: [], // { url, caption, seed, prompt }
        status: 'draft',
      },
      chatHistory: [], // { role: 'user' | 'model', parts: [{ text: '...' }] }
      isChatLoading: false,
      isImageLoading: false,

      // --- Actions ---

      // Navigation
      navigate: (page, activeIdeaId = null) => set({ page, activeIdeaId }),
      
      // Toast
      showToast: (message, type = 'success') => {
        const id = Date.now();
        set({ toast: { id, show: true, message, type } });
        setTimeout(() => {
          if (get().toast.id === id) {
             set(state => ({ toast: { ...state.toast, show: false } }));
          }
        }, 3000);
      },

      // Auth
      setUser: (user) => set({ user }),
      setUserInfo: (userInfo) => set({ userInfo }),
      setAuthReady: (isAuthReady) => set({ isAuthReady }),
      openAuthModal: () => set({ authModalOpen: true }),
      closeAuthModal: () => set({ authModalOpen: false }),

      // Data
      setIdeas: (ideas) => set({ ideas }),
      setActiveIdeaData: (data) => set({ activeIdeaData: data }),
      setActiveIdeaComments: (comments) => set({ activeIdeaComments: comments }),
      setActiveIdeaSubscriptions: (subs) => set({ activeIdeaSubscriptions: subs }),
      setActiveIdeaBetaSignups: (signups) => set({ activeIdeaBetaSignups: signups }),

      // Draft Management
      startNewDraft: () => {
        const { user } = get();
        if (!user || user.isAnonymous) {
          get().openAuthModal();
          get().showToast("Please sign in to start a new idea.", "info");
          return;
        }

        set({
          page: 'brainstorm',
          draft: {
            id: `draft_${Date.now()}`, // Temporary ID
            fields: { ...EMPTY_IDEA_FIELDS },
            locks: {},
            previews: [],
            status: 'draft',
          },
          chatHistory: [{
            role: 'model',
            parts: [{ text: "Hello! I'm here to help you brainstorm your next big web app. What idea are you thinking about today?" }]
          }]
        });
      },

      loadDraft: (idea) => {
        set({
          page: 'brainstorm',
          draft: {
            id: idea.id,
            fields: {
              ...EMPTY_IDEA_FIELDS, // Start with defaults
              ...Object.keys(EMPTY_IDEA_FIELDS).reduce((acc, key) => { // Overlay saved fields
                if (idea[key] !== undefined) {
                  acc[key] = idea[key];
                }
                return acc;
              }, {}),
            },
            locks: {}, // Locks are session-based, not saved
            previews: idea.previewImages || [],
            status: idea.status,
          },
          chatHistory: [
            { role: 'model', parts: [{ text: `Let's continue working on your idea: "${idea.title}". What's next?` }] }
          ]
        });
      },

      setDraftField: (key, value, source = 'user') => {
        const state = get();
        if (state.draft.locks[key] && source === 'ai') {
          console.log(`AI update to ${key} blocked by user lock.`);
          return; // Block AI change if locked
        }
        set(state => ({
          draft: {
            ...state.draft,
            fields: { ...state.draft.fields, [key]: value },
            lastUpdatedBy: source,
          }
        }));
        
        // Auto-save logic
        if (source === 'user') {
          state.saveDraftDebounced();
        }
      },

      toggleDraftLock: (key) => {
        set(state => ({
          draft: {
            ...state.draft,
            locks: { ...state.draft.locks, [key]: !state.draft.locks[key] }
          }
        }));
      },

      setChatHistory: (history) => set({ chatHistory: history }),
      setIsChatLoading: (isLoading) => set({ isChatLoading: isLoading }),
      setIsImageLoading: (isLoading) => set({ isImageLoading: isLoading }),
      
      addPreviewImage: (image) => {
        set(state => ({
          draft: {
            ...state.draft,
            previews: [...state.draft.previews, image]
          }
        }));
        get().saveDraftDebounced(); // Save after adding image
      },

      removePreviewImage: (index) => {
        const { draft, showToast } = get();
        const imageUrlToRemove = draft.previews[index]?.url;
        
        // Filter out the image
        const newPreviews = draft.previews.filter((_, i) => i !== index);
        
        // Check if the removed image was the cover image
        let newCoverImage = draft.fields.cover_image_url;
        if (draft.fields.cover_image_url === imageUrlToRemove) {
          // If it was, set cover to the new first image, or null if no images left
          newCoverImage = newPreviews.length > 0 ? newPreviews[0].url : null;
          showToast("Cover image was removed. Set a new one.", "info");
        }
        
        set(state => ({
          draft: {
            ...state.draft,
            previews: newPreviews,
            fields: {
              ...state.draft.fields,
              cover_image_url: newCoverImage
            }
          }
        }));
        
        get().saveDraftDebounced(); // Save after removing
      },

      setCoverImage: (imageUrl) => {
        set(state => ({
          draft: {
            ...state.draft,
            fields: { ...state.draft.fields, cover_image_url: imageUrl }
          }
        }));
        get().saveDraftDebounced();
      },

      // This will be wrapped in a debounce utility
      saveDraft: async () => {
        const { draft, user } = get();
        if (!draft.id || !user || user.isAnonymous) {
          console.log("Draft save skipped (no ID or user is anonymous)");
          return;
        }

        console.log("Auto-saving draft...");
        try {
          // Create the payload from fields and previews
          const payload = {
            ...draft.fields, // This is the object with title, oneLiner, etc.
            previewImages: draft.previews, // This is the array of images
            status: 'draft',
            authorId: user.uid,
            updatedAt: serverTimestamp(),
          };
          
          let docId = draft.id;
          
          // If it's a temporary ID, it's a new doc
          if (draft.id.startsWith('draft_')) {
            const newDocRef = await addDoc(collection(db, paths.ideas()), {
              ...payload,
              createdAt: serverTimestamp(),
            });
            docId = newDocRef.id;
            // Update the store with the real ID
            set(state => ({ draft: { ...state.draft, id: docId } }));
            get().showToast("Draft saved!", "success");
          } else {
            // Otherwise, update existing doc
            const docRef = doc(db, paths.idea(docId));
            await setDoc(docRef, payload, { merge: true }); // Use setDoc + merge to create or update
            get().showToast("Draft updated!", "success");
          }
        } catch (error) {
          console.error("Error saving draft:", error);
          get().showToast(`Error saving draft: ${error.message}`, "error");
        }
      },
      
      saveDraftDebounced: () => { /* This will be replaced by a debounced function */ },
      
      publishDraft: async () => {
        const { draft, user, showToast, navigate } = get();
        if (!draft.id || !user) return;
        
        // 10.4 Validation
        const missingFields = REQUIRED_FIELDS.filter(field => {
          const value = draft.fields[field];
          if (Array.isArray(value)) return value.length < 1;
          return !value;
        });

        if (missingFields.length > 0) {
          showToast(`Cannot publish. Missing required fields: ${missingFields.join(', ')}`, "error");
          // TODO: Scroll to field
          return;
        }

        if (draft.previews.length < 1) {
          showToast("Cannot publish. Please generate at least 1 preview image.", "error");
          return;
        }
        
        if (!draft.fields.cover_image_url) {
          showToast("Please select a cover image before publishing.", "error");
          return;
        }

        console.log("Publishing draft...");
        try {
          const slug = draft.fields.title.toLowerCase()
            .replace(/\s+/g, '-') // Replace spaces with -
            .replace(/[^\w-]+/g, '') // Remove all non-word chars
            .replace(/--+/g, '-') // Replace multiple - with single -
            .replace(/^-+/, '') // Trim - from start
            .replace(/-+$/, '') // Trim - from end
            .slice(0, 50);
          
          const uniqueSlug = `${slug}-${draft.id.slice(0, 5)}`;
          const docRef = doc(db, paths.idea(draft.id));
          
          const payload = {
            ...draft.fields,
            previewImages: draft.previews,
            status: 'published',
            slug: uniqueSlug,
            publishedAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
          };
          
          await setDoc(docRef, payload, { merge: true }); // Use setDoc + merge to ensure it's created/updated
          
          showToast("Idea published successfully!", "success");
          // Navigate to the detail page of the new idea
          navigate('ideaDetail', draft.id);
          
          // Start a new draft in the background so "brainstorm" page is fresh
          get().startNewDraft(); 
          // But keep the user on the idea detail page
          navigate('ideaDetail', draft.id);

        } catch (error) {
          console.error("Error publishing idea:", error);
          showToast(`Error publishing: ${error.message}`, "error");
        }
      },
    }));

    // --- (2) UTILITIES ---

    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Set debounced save function
    if (useGlobalStore.getState().saveDraft) {
      useGlobalStore.setState({
        saveDraftDebounced: debounce(useGlobalStore.getState().saveDraft, 1500)
      });
    }

    // --- (3) AI API INTEGRATION (Gemini) ---

    // Exponential backoff
    const fetchWithBackoff = async (url, options, retries = 4) => {
      let delay = 1000;
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, options);
          if (response.ok) {
            return response;
          }
          if (response.status === 429 || response.status >= 500) {
            // Throttling or server error, wait and retry
            console.warn(`API request failed with status ${response.status}. Retrying in ${delay}ms...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
          } else {
            // Client error, don't retry
            console.error(`API request failed with status ${response.status}. Not retrying.`);
            return response;
          }
        } catch (error) {
          // Network error, retry
          console.warn(`API request failed with network error. Retrying in ${delay}ms...`, error);
          await new Promise(resolve => setTimeout(resolve, delay));
          delay *= 2;
        }
      }
      throw new Error("API request failed after all retries.");
    };


    const gemini = {
      /**
       * 8.1 Chat -> Field Extraction
       * Calls Gemini with function calling to extract structured data.
       */
      getChatCompletion: async (history) => {
        const { showToast, setDraftField } = useGlobalStore.getState();
        const apiKey = ""; // Will be provided by environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${CHAT_MODEL}:generateContent?key=${apiKey}`;

        const systemPrompt = "You are a product ideation assistant. Ask targeted questions to complete a normalized app-idea schema. Output a JSON `fields` delta when you detect new facts. Never overwrite a field explicitly marked as `user_locked: true` (though this is handled client-side). Focus on one or two fields at a time.";

        // 8.1 JSON schema
        const schema = {
          type: "OBJECT",
          properties: {
            "extractedFields": {
              "type": "OBJECT",
              "description": "Any fields extracted from the user's last message. Only include detected fields.",
              "properties": {
                "title": {"type":"string"},
                "oneLiner": {"type":"string"},
                "audience": {"type":"string"},
                "problem": {"type":"string"},
                "features": {"type":"array","items":{"type":"string"}},
                "monetization": {"type":"string"},
                "techStack": {"type":"string"},
                "differentiators": {"type":"string"},
                "risks": {"type":"string"},
                "betaAvailable": {"type":"boolean"},
                "betaLink": {"type":"string"},
                "tags": {"type":"array","items":{"type":"string"}}
              }
            },
            "naturalResponse": {
              "type": "STRING",
              "description": "A natural, conversational response to the user, acknowledging the extracted info and asking a follow-up question."
            }
          },
          "required": ["naturalResponse"]
        };
        
        const payload = {
          contents: history,
          systemInstruction: {
            parts: [{ text: systemPrompt }]
          },
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: schema
          }
        };

        try {
          const response = await fetchWithBackoff(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          const candidate = result.candidates?.[0];
          
          if (!candidate) {
            console.error("Invalid AI response (no candidate):", result);
            throw new Error("No response candidate from AI.");
          }

          const part = candidate.content?.parts?.[0];
          
          if (part?.text) {
            let parsedJson;
            try {
               parsedJson = JSON.parse(part.text);
            } catch (e) {
              console.error("Failed to parse AI JSON response:", part.text, e);
              throw new Error("AI returned invalid JSON.");
            }
            
            const { extractedFields, naturalResponse } = parsedJson;
            
            // Update the store
            if (extractedFields) {
              console.log("AI suggests upserting fields:", extractedFields);
              for (const [key, value] of Object.entries(extractedFields)) {
                setDraftField(key, value, 'ai');
              }
            }
            
            if (!naturalResponse) {
              console.warn("AI response missing 'naturalResponse' field.");
              return { text: "Got it!", history: [...history, { role: 'model', parts: [part] }] };
            }
            
            // This is the final natural language response
            return { text: naturalResponse, history: [...history, { role: 'model', parts: [part] }] };
          }
          
          console.error("Invalid AI response (no part text):", result);
          return { text: "I'm not sure what to do with that. Can you rephrase?", history };

        } catch (error) {
          console.error("Error calling Gemini chat:", error);
          showToast(`AI Chat Error: ${error.message}`, "error");
          return { text: "Sorry, I encountered an error. Please try again.", history };
        }
      },

      /**
       * 8.2 Image Generation
       * Calls Imagen to generate UI mockups.
       */
      generateImage: async (prompt) => {
        const { showToast } = useGlobalStore.getState();
        const apiKey = ""; // Will be provided by environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL}:predict?key=${apiKey}`;

        const payload = {
          instances: [{ prompt }],
          parameters: { "sampleCount": 1 }
        };

        try {
          const response = await fetchWithBackoff(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          if (result.predictions && result.predictions[0]?.bytesBase64Encoded) {
            return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
          } else {
            console.error("Invalid image response format:", result);
            throw new Error("Invalid image response format.");
          }
        } catch (error) {
          console.error("Error calling Imagen:", error);
          showToast(`Image Generation Error: ${error.message}`, "error");
          return null;
        }
      }
    };

    // --- (4) FIREBASE API (Auth & Firestore) ---

    const firebaseApi = {
      // Auth
      signInWithGoogle: async () => {
        if (!auth) return;
        const { showToast, closeAuthModal } = useGlobalStore.getState();
        const provider = new GoogleAuthProvider();
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          // Create user doc if it doesn't exist
          const userDocRef = doc(db, paths.user(user.uid));
          const userDoc = await getDoc(userDocRef);
          if (!userDoc.exists()) {
            await setDoc(userDocRef, {
              email: user.email,
              displayName: user.displayName,
              avatarUrl: user.photoURL,
              handle: user.email.split('@')[0].replace(/[^a-z0-9]/g, '').slice(0, 20) || `user${user.uid.slice(0, 5)}`,
              bio: "",
              role: 'user',
              createdAt: serverTimestamp(),
            });
          }
          showToast("Signed in successfully!", "success");
          closeAuthModal();
        } catch (error) {
          console.error("Google sign-in error:", error);
          showToast(`Sign-in error: ${error.message}`, "error");
        }
      },
      
      signOut: async () => {
        if (!auth) return;
        const { showToast, navigate } = useGlobalStore.getState();
        try {
          await firebaseSignOut(auth);
          useGlobalStore.setState({ user: null, userInfo: null });
          showToast("Signed out.", "success");
          navigate('home');
        } catch (error) {
          console.error("Sign-out error:", error);
          showToast(`Sign-out error: ${error.message}`, "error");
        }
      },

      // Data Listeners
      listenToPublishedIdeas: () => {
        if (!db) return () => {};
        const { setIdeas } = useGlobalStore.getState();
        const q = query(collection(db, paths.ideas()), where("status", "==", "published"));
        
        return onSnapshot(q, (snapshot) => {
          const ideas = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .sort((a, b) => (b.publishedAt?.seconds || 0) - (a.publishedAt?.seconds || 0)); // Sort client-side
          setIdeas(ideas);
        }, (error) => {
          console.error("Error listening to ideas:", error);
        });
      },

      listenToActiveIdea: (ideaId) => {
        if (!db) return () => {};
        const { setActiveIdeaData, setActiveIdeaComments, setActiveIdeaSubscriptions, setActiveIdeaBetaSignups, navigate, showToast } = useGlobalStore.getState();
        
        const unsubIdea = onSnapshot(doc(db, paths.idea(ideaId)), (doc) => {
          if (doc.exists()) {
            setActiveIdeaData({ id: doc.id, ...doc.data() });
          } else {
            console.error("Idea not found");
            setActiveIdeaData(null);
            navigate('home');
            showToast("Error: Idea not found.", "error");
          }
        }, (error) => {
           console.error("Error listening to idea:", error);
           showToast("Error loading idea.", "error");
           navigate('home');
        });

        const unsubComments = onSnapshot(collection(db, paths.comments(ideaId)), (snapshot) => {
          const comments = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)); // Sort client-side
          setActiveIdeaComments(comments);
        }, (error) => console.error("Error listening to comments:", error));

        const unsubSubs = onSnapshot(collection(db, paths.subscriptions(ideaId)), (snapshot) => {
          const subs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setActiveIdeaSubscriptions(subs);
        }, (error) => console.error("Error listening to subscriptions:", error));

        const unsubBeta = onSnapshot(collection(db, paths.betaSignups(ideaId)), (snapshot) => {
          const signups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setActiveIdeaBetaSignups(signups);
        }, (error) => console.error("Error listening to beta signups:", error));

        return () => {
          unsubIdea();
          unsubComments();
          unsubSubs();
          unsubBeta();
        };
      },

      // Data Actions
      addComment: async (ideaId, text, parentId = null) => {
        if (!db) return;
        const { user, showToast } = useGlobalStore.getState();
        if (!user || user.isAnonymous) {
          showToast("Please sign in to comment.", "error");
          useGlobalStore.getState().openAuthModal();
          return;
        }
        
        try {
          await addDoc(collection(db, paths.comments(ideaId)), {
            ideaId: ideaId,
            authorId: user.uid,
            authorName: useGlobalStore.getState().userInfo?.displayName || "Guest",
            authorAvatar: useGlobalStore.getState().userInfo?.avatarUrl || null,
            body: text,
            parentId: parentId,
            status: 'active',
            createdAt: serverTimestamp(),
          });
          // showToast("Comment added!", "success"); // Maybe too noisy
        } catch (error) {
          console.error("Error adding comment:", error);
          showToast(`Error: ${error.message}`, "error");
        }
      },
      
      subscribeToIdea: async (ideaId) => {
        if (!db) return;
        const { user, showToast } = useGlobalStore.getState();
        if (!user || user.isAnonymous) {
          showToast("Please sign in to subscribe.", "error");
          useGlobalStore.getState().openAuthModal();
          return;
        }
        
        try {
          // Use UID as doc ID for easy checking
          const docRef = doc(db, paths.subscriptions(ideaId), user.uid);
          await setDoc(docRef, {
            ideaId: ideaId,
            userId: user.uid,
            email: user.email,
            channels: ['email'], // per spec
            createdAt: serverTimestamp(),
          });
          showToast("Subscribed successfully!", "success");
        } catch (error) {
          console.error("Error subscribing:", error);
          showToast(`Error: ${error.message}`, "error");
        }
      },
      
      joinBeta: async (ideaId, useCase) => {
        if (!db) return;
        const { user, showToast } = useGlobalStore.getState();
        if (!user || user.isAnonymous) {
          showToast("Please sign in to join the beta.", "error");
          useGlobalStore.getState().openAuthModal();
          return;
        }
        
        try {
          // Use UID as doc ID for easy checking
          const docRef = doc(db, paths.betaSignups(ideaId), user.uid);
          await setDoc(docRef, {
            ideaId: ideaId,
            userId: user.uid,
            email: user.email,
            name: useGlobalStore.getState().userInfo?.displayName || user.email,
            useCase: useCase || "",
            status: 'new',
            createdAt: serverTimestamp(),
          });
          showToast("You've joined the beta waitlist!", "success");
        } catch (error) {
          console.error("Error joining beta:", error);
          showToast(`Error: ${error.message}`, "error");
        }
      },

      getUserDrafts: async (userId) => {
        if (!db) return [];
        const q = query(
          collection(db, paths.ideas()), 
          where("authorId", "==", userId),
          where("status", "==", "draft")
        );
        const snapshot = await getDocs(q);
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      },
      
      getUserPublished: async (userId) => {
        if (!db) return [];
        const q = query(
          collection(db, paths.ideas()), 
          where("authorId", "==", userId),
          where("status", "==", "published")
        );
        const snapshot = await getDocs(q);
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      },
      
      getUserSubscriptions: async (userId) => {
        // This query is inefficient as noted.
        // A better model: /users/{userId}/subscriptions collection.
        console.warn("getUserSubscriptions is inefficient and not implemented.");
        return [];
      },
    };

    // --- (5) REACT COMPONENTS ---

    /**
     * LoadingSpinner
     * A simple loading spinner
     */
    const LoadingSpinner = ({ size = 'md' }) => {
      const s = {
        sm: 'h-5 w-5',
        md: 'h-8 w-8',
        lg: 'h-12 w-12',
      };
      return (
        <div className="flex justify-center items-center">
          <Loader2 className={`animate-spin text-blue-500 ${s[size]}`} />
        </div>
      );
    };

    /**
     * Button
     * A reusable button component
     */
    const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
      const variants = {
        primary: 'bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-400',
        secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 disabled:bg-gray-100',
        outline: 'border border-gray-300 text-gray-700 hover:bg-gray-100 disabled:text-gray-400 disabled:border-gray-200',
        danger: 'bg-red-600 text-white hover:bg-red-700 disabled:bg-red-400',
        ghost: 'bg-transparent text-gray-700 hover:bg-gray-100 disabled:text-gray-400',
      };
      return (
        <button
          onClick={onClick}
          className={`px-4 py-2 rounded-lg font-semibold shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center space-x-2 ${variants[variant]} ${className}`}
          {...props}
        >
          {children}
        </button>
      );
    };

    /**
     * Input
     * A reusable input component
     */
    const Input = React.forwardRef(({ label, id, ...props }, ref) => (
      <div className="w-full">
        {label && <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
        <input
          id={id}
          ref={ref}
          className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          {...props}
        />
      </div>
    ));

    /**
     * TextArea
     * A reusable textarea component
     */
    const TextArea = React.forwardRef(({ label, id, rows = 4, ...props }, ref) => (
      <div className="w-full">
        {label && <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
        <textarea
          id={id}
          ref={ref}
          rows={rows}
          className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          {...props}
        />
      </div>
    ));

    /**
     * Tag
     * A small tag component
     */
    const Tag = ({ children, className = '' }) => (
      <span className={`inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full ${className}`}>
        {children}
      </span>
    );

    /**
     * Header
     * The main site navigation header
     */
    const Header = () => {
      const { navigate, user, openAuthModal, startNewDraft } = useGlobalStore(state => ({
        navigate: state.navigate,
        user: state.user,
        openAuthModal: state.openAuthModal,
        startNewDraft: state.startNewDraft,
      }));

      const [menuOpen, setMenuOpen] = useState(false);
      const userInfo = useGlobalStore(s => s.userInfo);
      const menuRef = useRef(null);
      
      // Close menu on click outside
      useEffect(() => {
        const handleClickOutside = (event) => {
          if (menuRef.current && !menuRef.current.contains(event.target)) {
            setMenuOpen(false);
          }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);

      return (
        <header className="bg-white/90 backdrop-blur-sm shadow-md sticky top-0 z-50">
          <nav className="container mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex justify-between items-center h-16">
              <div className="flex-shrink-0 flex items-center">
                <button onClick={() => navigate('home')} className="flex items-center space-x-2">
                  <Lightbulb className="h-8 w-8 text-blue-600" />
                  <span className="text-2xl font-bold text-gray-900">{APP_NAME}</span>
                </button>
              </div>
              <div className="hidden md:flex md:items-center md:space-x-6">
                <button onClick={() => navigate('community')} className="text-gray-600 hover:text-gray-900 font-medium flex items-center space-x-1">
                  <Users size={18} />
                  <span>Community</span>
                </button>
                <Button onClick={startNewDraft} variant="primary">
                  <Sparkles size={18} />
                  <span>Start Brainstorm</span>
                </Button>
                {user && !user.isAnonymous ? (
                  <div className="relative" ref={menuRef}>
                    <button onClick={() => setMenuOpen(!menuOpen)} className="flex items-center space-x-2">
                      <img 
                        src={userInfo?.avatarUrl || `https://placehold.co/40x40/E2E8F0/4A5568?text=${userInfo?.displayName?.[0] || 'U'}`} 
                        alt="User Avatar"
                        className="h-9 w-9 rounded-full"
                        onError={(e) => {
                          if (e.target.src !== 'https://placehold.co/40x40/E2E8F0/4A5568?text=U') {
                            e.target.src = 'https://placehold.co/40x40/E2E8F0/4A5568?text=U';
                          }
                        }}
                      />
                      <ChevronDown size={16} />
                    </button>
                    {menuOpen && (
                      <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-1 z-50 ring-1 ring-black ring-opacity-5">
                        <button
                          onClick={() => { navigate('dashboard'); setMenuOpen(false); }}
                          className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2"
                        >
                          <LayoutDashboard size={16} />
                          <span>Dashboard</span>
                        </button>
                        <button
                          onClick={() => { firebaseApi.signOut(); setMenuOpen(false); }}
                          className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2"
                        >
                          <LogOut size={16} />
                          <span>Sign Out</span>
                        </button>
                      </div>
                    )}
                  </div>
                ) : (
                  <Button onClick={openAuthModal} variant="outline">
                    <LogIn size={18} />
                    <span>Sign In</span>
                  </Button>
                )}
              </div>
              <div className="md:hidden">
                {/* Mobile menu button */}
                <Button onClick={startNewDraft} variant="primary" className="mr-2">
                  <Sparkles size={18} />
                </Button>
                 {user && !user.isAnonymous ? (
                   <img 
                      src={userInfo?.avatarUrl || `https://placehold.co/40x40/E2E8F0/4A5568?text=${userInfo?.displayName?.[0] || 'U'}`} 
                      alt="User Avatar"
                      className="h-9 w-9 rounded-full inline-block"
                      onClick={() => navigate('dashboard')}
                    />
                 ) : (
                   <Button onClick={openAuthModal} variant="outline">
                    <LogIn size={18} />
                  </Button>
                 )}
              </div>
            </div>
          </nav>
        </header>
      );
    };

    /**
     * AuthModal
     * Modal for signing in
     */
    const AuthModal = () => {
      const { authModalOpen, closeAuthModal } = useGlobalStore(state => ({
        authModalOpen: state.authModalOpen,
        closeAuthModal: state.closeAuthModal,
      }));
      
      if (!authModalOpen) return null;

      return (
        <div className="fixed inset-0 bg-black/50 z-[99] flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full relative">
            <button onClick={closeAuthModal} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
              <X size={24} />
            </button>
            <div className="text-center">
              <Lightbulb className="h-12 w-12 text-blue-600 mx-auto" />
              <h2 className="text-2xl font-bold text-gray-900 mt-4">Welcome to {APP_NAME}</h2>
              <p className="text-gray-600 mt-2">Sign in to brainstorm, publish, and connect with the community.</p>
            </div>
            <div className="mt-8 space-y-4">
              <Button onClick={firebaseApi.signInWithGoogle} className="w-full" variant="outline">
                {/* Simple Google Icon */}
                <svg className="h-5 w-5" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l0.001-0.001l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                <span>Sign in with Google</span>
              </Button>
              {/* Email/password form could go here */}
            </div>
          </div>
        </div>
      );
    };

    /**
     * Toast
     * A notification component
     */
    const Toast = () => {
      const { toast } = useGlobalStore(state => ({ toast: state.toast }));
      const [visible, setVisible] = useState(false);

      useEffect(() => {
        setVisible(toast.show);
      }, [toast]);
      
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
      };
      
      if (!toast.message) return null;

      return (
        <div 
          className={`fixed bottom-4 right-4 ${colors[toast.type]} text-white px-6 py-3 rounded-lg shadow-lg z-[100] transition-all duration-300 ${visible ? 'toast-visible' : 'toast-hidden'}`}
        >
          {toast.message}
        </div>
      );
    };

    /**
     * IdeaCard
     * A card to display an idea summary
     */
    const IdeaCard = ({ idea }) => {
      const { navigate } = useGlobalStore.getState();
      
      return (
        <div 
          className="bg-white rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl cursor-pointer flex flex-col"
          onClick={() => navigate('ideaDetail', idea.id)}
        >
          <img 
            src={idea.cover_image_url || 'https://placehold.co/600x400/EBF8FF/4299E1?text=App+Idea'} 
            alt={`${idea.title} cover`}
            className="w-full h-48 object-cover"
            onError={(e) => {
              if (e.target.src !== 'https://placehold.co/600x400/EBF8FF/4299E1?text=App+Idea') {
                e.target.src = 'https://placehold.co/600x400/EBF8FF/4299E1?text=App+Idea';
              }
            }}
          />
          <div className="p-5 flex-grow flex flex-col">
            <h3 className="text-xl font-bold text-gray-900 truncate">{idea.title}</h3>
            <p className="text-gray-600 mt-1 h-12 overflow-hidden text-ellipsis text-sm flex-grow">{idea.oneLiner}</p>
            <div className="mt-4 flex flex-wrap gap-2 h-6 overflow-hidden">
              {idea.tags?.slice(0, 3).map(tag => <Tag key={tag}>{tag}</Tag>)}
            </div>
            {/* Stats removed for simplicity, can be added back */}
          </div>
        </div>
      );
    };

    // --- (6) PAGE COMPONENTS ---

    /**
     * HomePage
     * Landing page
     */
    const HomePage = () => {
      const { ideas, startNewDraft } = useGlobalStore(s => ({ 
        ideas: s.ideas, 
        startNewDraft: s.startNewDraft,
      }));
      
      const featuredIdeas = ideas.slice(0, 6);
      
      return (
        <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
          {/* Hero Section */}
          <section className="text-center py-16">
            <h1 className="text-5xl md:text-6xl font-extrabold text-gray-900 leading-tight">
              Turn Your <span className="text-blue-600">Spark</span> Into
              <br />
              A <span className="text-blue-600">Shippable</span> Idea.
            </h1>
            <p className="mt-6 text-xl text-gray-600 max-w-2xl mx-auto">
              Brainstorm with AI, capture your vision in a structured form, generate stunning UI previews, and share with a community ready to give feedback.
            </p>
            <div className="mt-10">
              <Button onClick={startNewDraft} variant="primary" className="text-lg px-8 py-3 mx-auto">
                <Sparkles size={20} />
                <span>Start Brainstorming for Free</span>
              </Button>
            </div>
          </section>
          
          {/* Featured Ideas Section */}
          <section className="mt-16">
            <h2 className="text-3xl font-bold text-gray-900 text-center">Featured Ideas</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-8">
              {featuredIdeas.length > 0 ? (
                featuredIdeas.map(idea => <IdeaCard key={idea.id} idea={idea} />)
              ) : (
                <p className="text-gray-500 text-center col-span-3">No featured ideas yet. Be the first!</p>
              )}
            </div>
          </section>
        </div>
      );
    };

    /**
     * CommunityPage
     * List of all published ideas
     */
    const CommunityPage = () => {
      const ideas = useGlobalStore(s => s.ideas);
      const [filters, setFilters] = useState({ sort: 'new', tags: [], search: '' });

      const filteredIdeas = useMemo(() => {
        return ideas
          .filter(idea => 
            idea.title.toLowerCase().includes(filters.search.toLowerCase()) ||
            idea.oneLiner.toLowerCase().includes(filters.search.toLowerCase())
          );
        // TODO: Add tag filtering and sorting
      }, [ideas, filters]);

      return (
        <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
          <h1 className="text-4xl font-bold text-gray-900">Community Ideas</h1>
          
          {/* Filters */}
          <div className="flex flex-col md:flex-row gap-4 my-6">
            <Input 
              id="search"
              placeholder="Search ideas..."
              value={filters.search}
              onChange={e => setFilters(f => ({ ...f, search: e.target.value }))}
            />
            {/* TODO: Add sort and tag filters */}
          </div>

          {/* Grid */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-8">
            {filteredIdeas.length > 0 ? (
              filteredIdeas.map(idea => <IdeaCard key={idea.id} idea={idea} />)
            ) : (
              <p className="text-gray-500 text-center col-span-3">No ideas match your filters.</p>
            )}
          </div>
        </div>
      );
    };

    /**
     * BrainstormPage
     * The core Chat + Form + Previews UI
     */
    const BrainstormPage = () => {
      const { user, openAuthModal, publishDraft, draft } = useGlobalStore(s => ({
        user: s.user,
        openAuthModal: s.openAuthModal,
        publishDraft: s.publishDraft,
        draft: s.draft,
      }));
      
      if (!user || user.isAnonymous) {
        return (
          <div className="container mx-auto px-4 py-20 text-center">
            <AlertTriangle className="h-16 w-16 text-yellow-500 mx-auto" />
            <h2 className="mt-4 text-2xl font-bold">Please sign in</h2>
            <p className="mt-2 text-gray-600">You need to be signed in to start brainstorming.</p>
            <Button onClick={openAuthModal} className="mt-6">Sign In</Button>
          </div>
        );
      }

      // 10.4 Publish validation check for button disabled state
      const canPublish = useMemo(() => {
        if (!draft.previews || draft.previews.length < 1) return false;
        if (!draft.fields.cover_image_url) return false;
        for (const field of REQUIRED_FIELDS) {
          const value = draft.fields[field];
          if (Array.isArray(value) && value.length < 1) return false;
          if (!Array.isArray(value) && !value) return false;
        }
        return true;
      }, [draft]);

      return (
        <div className="flex flex-col h-[calc(100vh-64px)]"> {/* Full height minus header */}
          {/* Top Action Bar */}
          <div className="flex-shrink-0 bg-white border-b border-gray-200 px-4 py-3">
            <div className="container mx-auto flex justify-between items-center">
              <div>
                <h2 className="text-xl font-bold text-gray-900 truncate max-w-sm md:max-w-md">
                  {draft.fields.title || "New Idea Brainstorm"}
                </h2>
                <p className="text-sm text-gray-500">
                  Status: <span className="font-medium text-gray-700">{draft.status}</span>
                  {draft.id.startsWith('draft_') && ' (Unsaved)'}
                </p>
              </div>
              <div>
                <Button 
                  variant="primary" 
                  onClick={publishDraft}
                  disabled={!canPublish}
                  title={!canPublish ? "Please complete all required fields, generate at least one preview, and select a cover image." : "Publish to community"}
                >
                  Publish
                </Button>
              </div>
            </div>
          </div>
          
          {/* Main Content (Split View) */}
          <div className="flex-grow container mx-auto px-4 py-6 overflow-hidden">
            <div className="flex flex-col lg:flex-row h-full gap-6">
              
              {/* Left Side: Chat + Image Gen (60%) */}
              <div className="flex flex-col lg:w-3/5 h-full gap-4">
                <div className="flex-grow h-1/2 bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                  <ChatPanel />
                </div>
                <div className="flex-shrink-0 h-1/2 lg:h-2/5 bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                  <ImageGenPanel />
                </div>
              </div>
              
              {/* Right Side: Form (40%) */}
              <div className="lg:w-2/5 h-full bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                <FormPanel />
              </div>
            </div>
          </div>
        </div>
      );
    };

    /**
     * ChatPanel
     * 2.1 / 8.1 - AI Chat
     */
    const ChatPanel = () => {
      const { chatHistory, setChatHistory, isChatLoading, setIsChatLoading, draft } = useGlobalStore(s => ({
        chatHistory: s.chatHistory,
        setChatHistory: s.setChatHistory,
        isChatLoading: s.isChatLoading,
        setIsChatLoading: s.setIsChatLoading,
        draft: s.draft,
      }));
      const [input, setInput] = useState('');
      const chatEndRef = useRef(null);

      useEffect(() => {
        chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [chatHistory]);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!input.trim() || isChatLoading) return;
        
        const newUserMessage = { role: 'user', parts: [{ text: input }] };
        const newHistory = [...chatHistory, newUserMessage];
        setChatHistory(newHistory);
        setInput('');
        setIsChatLoading(true);

        // Call AI
        const { text, history: updatedHistory } = await gemini.getChatCompletion(newHistory);
        
        // Update history with AI's final response
        if (text) {
          // The 'part' is already in the updatedHistory from the gemini function
          setChatHistory(updatedHistory);
        } else {
          // Handle cases where AI only called a function
          setChatHistory(updatedHistory);
        }
        
        setIsChatLoading(false);
      };
      
      return (
        <div className="flex flex-col h-full">
          <div className="p-4 border-b border-gray-200">
            <h3 className="text-lg font-semibold text-gray-900">AI Brainstorming Chat</h3>
          </div>
          <div className="flex-grow p-4 space-y-4 overflow-y-auto">
            {chatHistory.map((msg, index) => {
              // msg.role is 'user' or 'model'
              // Don't display function calls (which aren't in chatHistory anyway)
              
              const isUser = msg.role === 'user';
              const text = msg.parts?.[0]?.text || '';
              
              // Try parsing if it's a model response that might be JSON
              let displayText = text;
              if (!isUser) {
                try {
                  const parsed = JSON.parse(text);
                  displayText = parsed.naturalResponse;
                } catch (e) {
                  // Not JSON, just display the text
                }
              }

              return (
                <div key={index} className={`flex ${isUser ? 'justify-end' : 'justify-start'}`}>
                  <div className={`p-3 rounded-lg max-w-lg ${isUser ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800'}`}>
                    {displayText}
                  </div>
                </div>
              );
            })}
            {isChatLoading && (
              <div className="flex justify-start">
                <div className="p-3 rounded-lg bg-gray-100 text-gray-800">
                  <LoadingSpinner size="sm" />
                </div>
              </div>
            )}
            <div ref={chatEndRef} />
          </div>
          <form onSubmit={handleSubmit} className="p-4 border-t border-gray-200">
            <div className="flex items-center space-x-2">
              <input
                type="text"
                value={input}
                onChange={(e) => setInput(e.target.value)}
                placeholder="Type your message..."
                className="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                disabled={isChatLoading}
              />
              <Button type="submit" variant="primary" disabled={isChatLoading || !input.trim()}>
                <Send size={18} />
              </Button>
            </div>
          </form>
        </div>
      );
    };

    /**
     * FormPanel
     * 2.1 / 4.3 - Structured Form
     */
    const FormPanel = () => {
      const { draft, setDraftField, toggleDraftLock } = useGlobalStore(s => ({
        draft: s.draft,
        setDraftField: s.setDraftField,
        toggleDraftLock: s.toggleDraftLock,
      }));
      
      const [highlighted, setHighlighted] = useState({});
      
      // 10.1: Highlight on AI update
      useEffect(() => {
        if (draft.lastUpdatedBy === 'ai') {
            const fields = draft.fields;
            // This is a simple implementation. A better one would compare prev/current draft.
            // For now, we'll just flash all fields when AI updates.
            const newHighlights = Object.keys(fields).reduce((acc, key) => ({ ...acc, [key]: true }), {});
            setHighlighted(newHighlights);
            const timer = setTimeout(() => setHighlighted({}), 2000); // 2s pulse
            return () => clearTimeout(timer);
        }
      }, [draft.fields, draft.lastUpdatedBy]);

      
      const fields = draft.fields;
      const locks = draft.locks;

      // Helper for array fields like features/tags
      const handleArrayChange = (key, value) => {
        setDraftField(key, value.split(',').map(s => s.trim()).filter(Boolean), 'user');
      };
      
      const getHighlightClass = (id) => {
        return highlighted[id] ? 'border-blue-500 ring-2 ring-blue-300 transition-all duration-300' : 'border-gray-300';
      };

      const FormField = ({ id, label, required, children }) => (
        <div className="py-3">
          <label htmlFor={id} className="block text-sm font-semibold text-gray-700 mb-1">
            {label} {required && <span className="text-red-500">*</span>}
          </label>
          <div className="flex items-center space-x-2">
            <div className="flex-grow">
              {children}
            </div>
            {/* 10.2: Lock button */}
            <button 
              onClick={() => toggleDraftLock(id)} 
              title={locks[id] ? "Unlock field (AI can edit)" : "Lock field (AI cannot edit)"}
              className={`p-2 rounded-lg ${locks[id] ? 'text-blue-600 bg-blue-100' : 'text-gray-400 hover:bg-gray-100'}`}
            >
              {locks[id] ? <Lock size={16} /> : <Unlock size={16} />}
            </button>
          </div>
        </div>
      );

      return (
        <div className="flex flex-col h-full">
          <div className="p-4 border-b border-gray-200">
            <h3 className="text-lg font-semibold text-gray-900">Idea Details</h3>
          </div>
          <div className="flex-grow p-4 overflow-y-auto divide-y divide-gray-200">
            <FormField id="title" label="Title" required>
              <Input 
                id="title" 
                value={fields.title} 
                onChange={e => setDraftField('title', e.target.value, 'user')} 
                className={getHighlightClass('title')}
              />
            </FormField>
            <FormField id="oneLiner" label="One-Liner" required>
              <Input 
                id="oneLiner" 
                value={fields.oneLiner} 
                onChange={e => setDraftField('oneLiner', e.target.value, 'user')} 
                className={getHighlightClass('oneLiner')}
              />
            </FormField>
            <FormField id="audience" label="Target Audience" required>
              <Input 
                id="audience" 
                value={fields.audience} 
                onChange={e => setDraftField('audience', e.target.value, 'user')} 
                className={getHighlightClass('audience')}
              />
            </FormField>
            <FormField id="problem" label="Problem to Solve" required>
              <TextArea 
                id="problem" 
                value={fields.problem} 
                onChange={e => setDraftField('problem', e.target.value, 'user')} 
                className={getHighlightClass('problem')}
              />
            </FormField>
            <FormField id="features" label="Core Features (comma-separated)" required>
              <Input 
                id="features" 
                value={fields.features.join(', ')} 
                onChange={e => handleArrayChange('features', e.target.value)}
                className={getHighlightClass('features')}
              />
            </FormField>
            <FormField id="monetization" label="Monetization Strategy" required>
              <Input 
                id="monetization" 
                value={fields.monetization} 
                onChange={e => setDraftField('monetization', e.target.value, 'user')} 
                className={getHighlightClass('monetization')}
              />
            </FormField>
            <FormField id="techStack" label="Tech Stack" required>
              <Input 
                id="techStack" 
                value={fields.techStack} 
                onChange={e => setDraftField('techStack', e.target.value, 'user')} 
                className={getHighlightClass('techStack')}
              />
            </FormField>
            <FormField id="tags" label="Tags (comma-separated)" required>
              <Input 
                id="tags" 
                value={fields.tags.join(', ')} 
                onChange={e => handleArrayChange('tags', e.target.value)}
                className={getHighlightClass('tags')}
              />
            </FormField>
            <FormField id="differentiators" label="Differentiators">
              <TextArea 
                id="differentiators" 
                value={fields.differentiators} 
                onChange={e => setDraftField('differentiators', e.target.value, 'user')} 
                className={getHighlightClass('differentiators')}
              />
            </FormField>
            <FormField id="risks" label="Risks">
              <TextArea 
                id="risks" 
                value={fields.risks} 
                onChange={e => setDraftField('risks', e.target.value, 'user')} 
                className={getHighlightClass('risks')}
              />
            </FormField>
             <FormField id="betaAvailable" label="Beta Available">
              <input 
                type="checkbox"
                id="betaAvailable"
                checked={fields.betaAvailable}
                onChange={e => setDraftField('betaAvailable', e.target.checked, 'user')}
                className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
              />
            </FormField>
          </div>
        </div>
      );
    };

    /**
     * ImageGenPanel
     * 2.1 / 8.2 - UI Preview Generation
     */
    const ImageGenPanel = () => {
      const { draft, addPreviewImage, removePreviewImage, setCoverImage, isImageLoading, setIsImageLoading } = useGlobalStore(s => ({
        draft: s.draft,
        addPreviewImage: s.addPreviewImage,
        removePreviewImage: s.removePreviewImage,
        setCoverImage: s.setCoverImage,
        isImageLoading: s.isImageLoading,
        setIsImageLoading: s.setIsImageLoading,
      }));
      
      const scenes = ["Landing Page", "Dashboard", "Settings Page"];

      const handleGenerate = async () => {
        setIsImageLoading(true);
        const { title, oneLiner, features } = draft.fields;
        
        if (!title || !oneLiner) {
          useGlobalStore.getState().showToast("Please provide a Title and One-Liner first.", "error");
          setIsImageLoading(false);
          return;
        }
        
        const generatedImages = [];
        
        for (const scene of scenes) {
          // 8.2 Prompt Template
          const prompt = `Create a clean, modern SaaS interface mockup for an app called "${title}". The app is: "${oneLiner}". Show the "${scene}". Style: neutral white background, soft blue accents (#3B82F6), subtle shadows, rounded corners. Include plausible UI elements related to features like: ${features.join(', ')}. Avoid text-heavy paragraphs; focus on layout.`;
          
          try {
            const imageUrl = await gemini.generateImage(prompt);
            if (imageUrl) {
              const newImage = {
                url: imageUrl,
                caption: scene,
                prompt: prompt,
              };
              addPreviewImage(newImage); // Add to store one by one
              generatedImages.push(newImage);
            }
          } catch (e) {
            console.error(`Failed to generate image for scene: ${scene}`, e);
            useGlobalStore.getState().showToast(`Failed to generate image for ${scene}.`, "error");
          }
        }
        
        // Auto-select first image as cover if none is set
        if (generatedImages.length > 0 && !draft.fields.cover_image_url) {
          setCoverImage(generatedImages[0].url);
        }
        
        setIsImageLoading(false);
      };
      
      return (
        <div className="flex flex-col h-full">
          <div className="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 className="text-lg font-semibold text-gray-900">UI Previews</h3>
            <Button onClick={handleGenerate} disabled={isImageLoading}>
              {isImageLoading ? <LoadingSpinner size="sm" /> : <ImageIcon size={18} />}
              <span>{isImageLoading ? "Generating..." : "Generate Previews"}</span>
            </Button>
          </div>
          <div className="flex-grow p-4 overflow-x-auto">
            <div className="flex space-x-4 h-full">
              {isImageLoading && draft.previews.length === 0 && (
                <div className="flex-1 flex items-center justify-center text-gray-500">
                  <LoadingSpinner />
                  <span className="ml-2">Generating images...</span>
                </div>
              )}
              {!isImageLoading && draft.previews.length === 0 && (
                <div className="flex-1 flex items-center justify-center text-gray-500">
                  Click "Generate Previews" to create UI mockups.
                </div>
              )}
              {draft.previews.map((img, index) => (
                <div key={index} className="flex-shrink-0 w-64 h-full relative group">
                  <img 
                    src={img.url} 
                    alt={img.caption}
                    className="w-full h-full object-cover rounded-lg border border-gray-200"
                  />
                  <div className={`absolute inset-0 rounded-lg transition-all duration-300 ${
                    draft.fields.cover_image_url === img.url 
                      ? 'ring-4 ring-blue-500' 
                      : 'ring-1 ring-transparent'
                  }`} />
                  <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center space-x-2">
                    <Button 
                      variant={draft.fields.cover_image_url === img.url ? 'primary' : 'secondary'}
                      onClick={() => setCoverImage(img.url)}
                      className="text-xs px-2 py-1"
                      title="Set as Cover"
                    >
                      <Check size={14} />
                    </Button>
                    <Button
                      variant="danger"
                      onClick={() => removePreviewImage(index)}
                      className="text-xs px-2 py-1"
                      title="Delete Image"
                    >
                      <Trash2 size={14} />
                    </Button>
                  </div>
                  <p className="absolute bottom-1 left-1 bg-black/60 text-white text-xs px-2 py-0.5 rounded">
                    {img.caption}
                  </p>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    /**
     * IdeaDetailPage
     * 2.1 / 3.2 - View a single published idea
     */
    const IdeaDetailPage = () => {
      const { 
        activeIdeaId, 
        activeIdeaData: idea, 
        activeIdeaComments: comments,
        activeIdeaSubscriptions: subs,
        activeIdeaBetaSignups: signups,
        user,
        userInfo,
        showToast
      } = useGlobalStore(s => ({
        activeIdeaId: s.activeIdeaId,
        activeIdeaData: s.activeIdeaData,
        activeIdeaComments: s.activeIdeaComments,
        activeIdeaSubscriptions: s.activeIdeaSubscriptions,
        activeIdeaBetaSignups: s.activeIdeaBetaSignups,
        user: s.user,
        userInfo: s.userInfo,
        showToast: s.showToast,
      }));
      
      useEffect(() => {
        if (!activeIdeaId) return;
        const unsub = firebaseApi.listenToActiveIdea(activeIdeaId);
        return () => unsub();
      }, [activeIdeaId]);

      if (!idea) {
        return <div className="container mx-auto p-8 text-center"><LoadingSpinner size="lg" /></div>;
      }
      
      const isSubscribed = user && subs.some(s => s.userId === user.uid);
      const isBetaJoined = user && signups.some(s => s.userId === user.uid);
      
      const [betaUseCase, setBetaUseCase] = useState('');
      const [showBetaModal, setShowBetaModal] = useState(false);
      
      const handleJoinBeta = async () => {
        await firebaseApi.joinBeta(idea.id, betaUseCase);
        setShowBetaModal(false);
        setBetaUseCase('');
      };
      
      const BetaModal = () => (
        <div className="fixed inset-0 bg-black/50 z-[99] flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full relative">
            <button onClick={() => setShowBetaModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
              <X size={24} />
            </button>
            <h2 className="text-2xl font-bold text-gray-900">Join Beta for {idea.title}</h2>
            <p className="text-gray-600 mt-2">We're excited to have you! You'll be signed up with {user.email}.</p>
            <TextArea 
              label="Optional: How do you plan to use this app?"
              id="beta_use_case"
              value={betaUseCase}
              onChange={e => setBetaUseCase(e.target.value)}
              className="mt-4"
              rows={3}
            />
            <Button onClick={handleJoinBeta} className="mt-6 w-full" variant="primary">
              Join Beta Waitlist
            </Button>
          </div>
        </div>
      );

      return (
        <div className="bg-white">
          <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
            {showBetaModal && <BetaModal />}
            
            {/* Header */}
            <div className="max-w-4xl mx-auto">
              <div className="flex flex-wrap gap-2 mb-4">
                {idea.tags?.map(tag => <Tag key={tag}>{tag}</Tag>)}
              </div>
              <h1 className="text-4xl md:text-5xl font-extrabold text-gray-900">{idea.title}</h1>
              <p className="mt-4 text-xl text-gray-600">{idea.oneLiner}</p>
              {/* TODO: Author byline */}
              
              <div className="mt-8 flex flex-col sm:flex-row gap-4">
                <Button 
                  onClick={() => firebaseApi.subscribeToIdea(idea.id)} 
                  disabled={isSubscribed}
                  variant="primary"
                >
                  <Bell size={18} />
                  <span>{isSubscribed ? "Subscribed" : "Subscribe to Updates"}</span>
                </Button>
                {idea.betaAvailable && (
                  <Button 
                    onClick={() => {
                      if (!user || user.isAnonymous) {
                        showToast("Please sign in to join the beta.", "error");
                        useGlobalStore.getState().openAuthModal();
                        return;
                      }
                      setShowBetaModal(true);
                    }} 
                    disabled={isBetaJoined}
                    variant="outline"
                  >
                    <Check size={18} />
                    <span>{isBetaJoined ? "You're on the list!" : "Join Beta"}</span>
                  </Button>
                )}
              </div>
            </div>
            
            {/* Cover Image */}
            <div className="max-w-5xl mx-auto mt-12">
              <img 
                src={idea.cover_image_url} 
                alt={`${idea.title} cover`}
                className="w-full rounded-xl shadow-2xl aspect-video object-cover"
                onError={(e) => {
                  if (e.target.src !== 'https://placehold.co/1200x675/EBF8FF/4299E1?text=App+Idea') {
                    e.target.src = 'https://placehold.co/1200x675/EBF8FF/4299E1?text=App+Idea';
                  }
                }}
              />
            </div>
            
            {/* Main Content (2-col) */}
            <div className="max-w-4xl mx-auto mt-12 grid grid-cols-1 md:grid-cols-3 gap-12">
              
              {/* Left Col: Details */}
              <div className="md:col-span-2 space-y-8">
                <section>
                  <h2 className="text-2xl font-bold text-gray-900 border-b pb-2">The Problem</h2>
                  <p className="text-gray-700 mt-4 whitespace-pre-wrap">{idea.problem}</p>
                </section>
                <section>
                  <h2 className="text-2xl font-bold text-gray-900 border-b pb-2">Core Features</h2>
                  <ul className="list-disc list-inside text-gray-700 mt-4 space-y-2">
                    {idea.features?.map(f => <li key={f}>{f}</li>)}
                  </ul>
                </section>
                {idea.differentiators && (
                  <section>
                    <h2 className="text-2xl font-bold text-gray-900 border-b pb-2">Differentiators</h2>
                    <p className="text-gray-700 mt-4 whitespace-pre-wrap">{idea.differentiators}</p>
                  </section>
                )}
                {idea.risks && (
                  <section>
                    <h2 className="text-2xl font-bold text-gray-900 border-b pb-2">Risks</h2>
                    <p className="text-gray-700 mt-4 whitespace-pre-wrap">{idea.risks}</p>
                  </section>
                )}
                <section>
                  <h2 className="text-2xl font-bold text-gray-900 border-b pb-2">Preview Gallery</h2>
                  <div className="grid grid-cols-2 gap-4 mt-4">
                    {idea.previewImages?.map((img, i) => (
                      <img 
                        key={i} 
                        src={img.url} 
                        alt={img.caption}
                        className="w-full rounded-lg shadow-md aspect-video object-cover"
                      />
                    ))}
                  </div>
                </section>
              </div>
              
              {/* Right Col: Meta */}
              <aside className="space-y-6">
                <div className="bg-gray-50 p-5 rounded-lg shadow-sm border">
                  <h3 className="text-lg font-semibold">Audience</h3>
                  <p className="text-gray-600 mt-1">{idea.audience}</p>
                </div>
                <div className="bg-gray-50 p-5 rounded-lg shadow-sm border">
                  <h3 className="text-lg font-semibold">Monetization</h3>
                  <p className="text-gray-600 mt-1">{idea.monetization}</p>
                </div>
                <div className="bg-gray-50 p-5 rounded-lg shadow-sm border">
                  <h3 className="text-lg font-semibold">Tech Stack</h3>
                  <p className="text-gray-600 mt-1">{idea.techStack}</p>
                </div>
                 <div className="bg-gray-50 p-5 rounded-lg shadow-sm border">
                  <h3 className="text-lg font-semibold">Stats</h3>
                  <p className="text-gray-600 mt-2 flex items-center space-x-2">
                    <MessageSquare size={16} /> 
                    <span>{comments.length} Comments</span>
                  </p>
                  <p className="text-gray-600 mt-2 flex items-center space-x-2">
                    <Bell size={16} /> 
                    <span>{subs.length} Subscribers</span>
                  </p>
                  <p className="text-gray-600 mt-2 flex items-center space-x-2">
                    <Check size={16} /> 
                    <span>{signups.length} Beta Signups</span>
                  </p>
                </div>
              </aside>
            </div>
            
            {/* Comments */}
            <div className="max-w-3xl mx-auto mt-16">
              <CommentsSection ideaId={idea.id} comments={comments} />
            </div>
            
          </div>
        </div>
      );
    };

    /**
     * CommentsSection
     * 2.2 - List and add comments
     */
    const CommentsSection = ({ ideaId, comments }) => {
      const [newComment, setNewComment] = useState('');
      const { user, userInfo } = useGlobalStore(s => ({ user: s.user, userInfo: s.userInfo }));

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!newComment.trim()) return;
        await firebaseApi.addComment(ideaId, newComment);
        setNewComment('');
      };

      return (
        <section>
          <h2 className="text-3xl font-bold text-gray-900">Community Feedback</h2>
          <div className="mt-6 space-y-6">
            {comments.length === 0 && (
              <p className="text-gray-500">Be the first to leave a comment!</p>
            )}
            {comments.map(comment => (
              <div key={comment.id} className="flex space-x-4">
                <img 
                  src={comment.authorAvatar || `https://placehold.co/40x40/E2E8F0/4A5568?text=${comment.authorName?.[0] || 'U'}`} 
                  alt={`${comment.authorName} avatar`}
                  className="h-10 w-10 rounded-full flex-shrink-0"
                  onError={(e) => {
                    if (e.target.src !== 'https://placehold.co/40x40/E2E8F0/4A5568?text=U') {
                      e.target.src = 'https://placehold.co/40x40/E2E8F0/4A5568?text=U';
                    }
                  }}
                />
                <div className="flex-grow">
                  <p className="font-semibold text-gray-800">
                    {comment.authorName}
                  </p>
                  <p className="text-gray-700 mt-1">{comment.body}</p>
                  <p className="text-xs text-gray-400 mt-1">
                    {comment.createdAt ? new Date(comment.createdAt.seconds * 1000).toLocaleString() : 'Just now'}
                  </p>
                </div>
              </div>
            ))}
          </div>
          <form onSubmit={handleSubmit} className="mt-8 flex space-x-4">
            <img 
              src={userInfo?.avatarUrl || `https://placehold.co/40x40/E2E8F0/4A5568?text=U`} 
              alt="Your avatar"
              className="h-10 w-10 rounded-full flex-shrink-0"
              onError={(e) => {
                if (e.target.src !== 'https://placehold.co/40x40/E2E8F0/4A5568?text=U') {
                  e.target.src = 'https://placehold.co/40x40/E2E8F0/4A5568?text=U';
                }
              }}
            />
            <div className="flex-grow">
              <TextArea 
                id="new_comment"
                rows={3}
                value={newComment}
                onChange={e => setNewComment(e.target.value)}
                placeholder={(!user || user.isAnonymous) ? "Please sign in to comment." : "Share your thoughts, feedback, or questions..."}
                disabled={!user || user.isAnonymous}
                className="w-full"
              />
              <Button type="submit" variant="primary" className="mt-2" disabled={!user || user.isAnonymous || !newComment.trim()}>
                Post Comment
              </Button>
            </div>
          </form>
        </section>
      );
    };

    /**
     * DashboardPage
     * 3.2 - My Drafts, My Published, etc.
     */
    const DashboardPage = () => {
      const [tab, setTab] = useState('drafts');
      const { user, openAuthModal } = useGlobalStore(s => ({
         user: s.user,
         openAuthModal: s.openAuthModal
      }));
      const navigate = useGlobalStore(s => s.navigate);
      const loadDraft = useGlobalStore(s => s.loadDraft);
      
      const [drafts, setDrafts] = useState([]);
      const [published, setPublished] = useState([]);
      const [loading, setLoading] = useState(true);
      
      useEffect(() => {
        if (!user || user.isAnonymous) {
          setLoading(false);
          return;
        }
        setLoading(true);
        Promise.all([
          firebaseApi.getUserDrafts(user.uid),
          firebaseApi.getUserPublished(user.uid)
        ]).then(([draftsData, publishedData]) => {
          setDrafts(draftsData);
          setPublished(publishedData);
          setLoading(false);
        }).catch(e => {
          console.error("Error loading dashboard data:", e);
          setLoading(false);
        });
      }, [user, tab]);
      
      if (!user || user.isAnonymous) {
        return (
          <div className="container mx-auto px-4 py-20 text-center">
            <AlertTriangle className="h-16 w-16 text-yellow-500 mx-auto" />
            <h2 className="mt-4 text-2xl font-bold">Please sign in</h2>
            <p className="mt-2 text-gray-600">You need to be signed in to view your dashboard.</p>
            <Button onClick={openAuthModal} className="mt-6">Sign In</Button>
          </div>
        );
      }

      const TabButton = ({ id, label }) => (
        <button
          onClick={() => setTab(id)}
          className={`px-4 py-2 font-medium ${tab === id ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
        >
          {label}
        </button>
      );

      const renderContent = () => {
        if (loading) {
          return <div className="text-center p-12"><LoadingSpinner size="lg" /></div>;
        }
        
        switch(tab) {
          case 'drafts':
            return (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {drafts.length === 0 && <p>You have no drafts.</p>}
                {drafts.map(idea => (
                  <div key={idea.id} className="bg-white p-4 rounded-lg shadow border flex flex-col justify-between">
                    <div>
                      <h3 className="text-lg font-bold">{idea.title || "Untitled Draft"}</h3>
                      <p className="text-sm text-gray-500 h-10 truncate">{idea.oneLiner}</p>
                    </div>
                    <Button onClick={() => loadDraft(idea)} className="mt-4 text-sm px-3 py-1 w-full">
                      Edit Draft
                    </Button>
                  </div>
                ))}
              </div>
            );
          case 'published':
            return (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {published.length === 0 && <p>You have no published ideas.</p>}
                {published.map(idea => (
                  <IdeaCard key={idea.id} idea={idea} />
                ))}
              </div>
            );
          case 'subscriptions':
            return <p>My Subscriptions (Not Implemented)</p>;
          default:
            return null;
        }
      };

      return (
        <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
          <h1 className="text-4xl font-bold text-gray-900">My Dashboard</h1>
          <div className="border-b border-gray-200 mt-8">
            <nav className="-mb-px flex space-x-6">
              <TabButton id="drafts" label="My Drafts" />
              <TabButton id="published" label="My Published" />
              <TabButton id="subscriptions" label="My Subscriptions" />
            </nav>
          </div>
          <div className="mt-8">
            {renderContent()}
          </div>
        </div>
      );
    };


    // --- (7) MAIN APP COMPONENT ---

    function App() {
      const { 
        page, 
        isAuthReady, 
        setUser, 
        setUserInfo, 
        setAuthReady,
        activeIdeaId
      } = useGlobalStore(s => ({
        page: s.page,
        isAuthReady: s.isAuthReady,
        setUser: s.setUser,
        setUserInfo: s.setUserInfo,
        setAuthReady: s.setAuthReady,
        activeIdeaId: s.activeIdeaId,
      }));

      // Effect for auth
      useEffect(() => {
        if (!auth || !db) return; // Firebase not initialized
        
        let userListener = () => {};
        let profileListener = () => {};

        const authPromise = typeof __initial_auth_token !== 'undefined'
          ? signInWithCustomToken(auth, __initial_auth_token)
          : signInAnonymously(auth);

        authPromise.catch(error => {
          console.error("Initial sign-in error:", error);
        }).finally(() => {
          userListener = onAuthStateChanged(auth, (user) => {
            console.log("Auth state changed, user:", user?.uid, "isAnonymous:", user?.isAnonymous);
            setUser(user);
            
            // Kill old profile listener
            if (profileListener) profileListener(); 
            
            if (user && !user.isAnonymous) {
              // Listen to user profile
              const userDocRef = doc(db, paths.user(user.uid));
              profileListener = onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                  console.log("User profile loaded:", doc.data().displayName);
                  setUserInfo(doc.data());
                } else {
                  console.warn("User profile not found, creating...");
                  // This should have been created on sign-up, but as a fallback:
                  setDoc(userDocRef, {
                    email: user.email,
                    displayName: user.displayName,
                    avatarUrl: user.photoURL,
                    handle: user.email.split('@')[0].replace(/[^a-z0-9]/g, '').slice(0, 20) || `user${user.uid.slice(0, 5)}`,
                    createdAt: serverTimestamp(),
                    role: 'user',
                  }).catch(e => console.error("Error creating fallback user doc:", e));
                }
              }, (error) => {
                console.error("Error listening to user profile:", error);
              });
            } else {
              setUserInfo(null);
            }
            setAuthReady(true);
          });
        });

        return () => {
          userListener();
          if (profileListener) profileListener();
        };
      }, [setUser, setUserInfo, setAuthReady, auth, db]); // Add auth and db as dependencies

      // Effect for data listeners
      useEffect(() => {
        if (!db) return; // Firebase not initialized
        // Only listen to public ideas
        const unsubIdeas = firebaseApi.listenToPublishedIdeas();
        return () => unsubIdeas();
      }, [db]); // Add db as dependency
      
      // Main page renderer
      const renderPage = () => {
        switch (page) {
          case 'home':
            return <HomePage />;
          case 'community':
            return <CommunityPage />;
          case 'brainstorm':
            return <BrainstormPage />;
          case 'ideaDetail':
            return <IdeaDetailPage />;
          case 'dashboard':
            return <DashboardPage />;
          default:
            return <HomePage />;
        }
      };
      
      if (!auth || !db) {
        // This will be shown if the fallback config is also missing/invalid
         return (
          <div style={{ padding: '2rem', textAlign: 'center', fontFamily: 'sans-serif', color: 'red' }}>
            <h2>Critical Firebase Error</h2>
            <p>Firebase services could not be initialized. The app cannot run.</p>
          </div>
        );
      }

      if (!isAuthReady) {
        return (
          <div className="flex items-center justify-center h-screen">
            <LoadingSpinner size="lg" />
          </div>
        );
      }

      return (
        <div className="min-h-screen">
          <Header />
          <main>
            {renderPage()}
          </main>
          <AuthModal />
          <Toast />
        </div>
      );
    }
    
    // --- (B) Render the App ---
    if (document.getElementById('root') && app) {
      ReactDOM.render(<App />, document.getElementById('root'));
    }

  </script>
</body>
</html>


